<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Standard Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The ultimate IP finder with tools: IP, IPv6, ISP, ASN, hostname, network, VPN, DNS, ports, threats, traceroute, WHOIS, speed test, and map.">
    <meta name="keywords" content="What is my IP, find IP address, check my IP, public IP lookup, IP location, IPv6, ISP, ASN, hostname, VPN detection, network status, DNS leak, port scanner, threat detection, traceroute, WHOIS, speed test">
    <meta name="author" content="TechFixPro">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph for Social Media -->
    <meta property="og:title" content="What's My IP? - Ultimate IP & Network Toolkit">
    <meta property="og:description" content="Explore your IP, network, VPN, DNS, ports, threats, traceroute, WHOIS, speed, and location with a sleek map.">
    <meta property="og:url" content="https://whatsmyip.techfixpro.net">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://techfixpro.net/icon.png">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="What's My IP? - Ultimate IP & Network Toolkit">
    <meta name="twitter:description" content="Explore your IP, network, VPN, DNS, ports, threats, traceroute, WHOIS, speed, and location with a sleek map.">
    <meta name="twitter:image" content="https://techfixpro.net/icon.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://whatsmyip.techfixpro.net">

    <!-- Favicon -->
    <link rel="icon" href="https://techfixpro.net/icon.png" type="image/x-icon">

    <!-- Page Title -->
    <title>What's My IP? - Ultimate IP & Network Toolkit</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">

    <!-- Google Ads -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4778277727361005" crossorigin="anonymous"></script>

    <!-- Google Tag for Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XJTPL90T10"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XJTPL90T10');
    </script>

    <!-- Custom Styles -->
    <style>
        :root {
            --primary-color: linear-gradient(135deg, #3498db, #2ecc71);
            --background: #e8ecef;
            --text-color: #2d3748;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: rgba(0, 0, 0, 0.15);
            --dark-bg: #1a202c;
            --dark-card: rgba(26, 32, 44, 0.95);
            --dark-text: #e2e8f0;
            --success: #2ecc71;
            --warning: #e74c3c;
            --accent: #3498db;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }
        body.dark {
            background: var(--dark-bg);
            color: var(--dark-text);
        }
        .container {
            max-width: 900px;
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 10px 30px var(--shadow);
            animation: fadeIn 0.8s ease-in-out;
            width: 100%;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow);
        }
        .dark .container {
            background: var(--dark-card);
        }
        h1 {
            color: #3498db;
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 30px;
            text-shadow: 0 2px 5px var(--shadow);
        }
        .ip-container {
            background: #f7fafc;
            padding: 25px;
            border-radius: 16px;
            margin: 20px auto;
            font-size: 30px;
            font-weight: bold;
            display: flex;
            flex-wrap: wrap;
            gap: 35px;
            justify-content: center;
            align-items: center;
        }
        .dark .ip-container {
            background: #2d3748;
        }
        .ip-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-btn {
            background: none;
            border: none;
            color: #3498db;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .info-btn:hover {
            transform: scale(1.2);
        }
        .info-text {
            display: none;
            background: #edf2f7;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            color: #4a5568;
            position: absolute;
            left: 100%;
            top: 0;
            width: 200px;
            z-index: 10;
            box-shadow: 0 5px 15px var(--shadow);
        }
        .dark .info-text {
            background: #2d3748;
            color: #b0b8cc;
        }
        .info-item:hover .info-text {
            display: block;
        }
        .status-badge {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 14px;
            margin-left: 10px;
            color: #fff;
            transition: background 0.2s ease;
        }
        .online { background: var(--success); }
        .offline { background: var(--warning); }
        .vpn-detected { background: #f39c12; }
        .threat-detected { background: #e74c3c; }
        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        #copy-btn, #copy-all-btn, #refresh-btn, #export-btn, #port-scan-btn, #traceroute-btn, #whois-btn, #speed-test-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        #copy-btn:hover:not(:disabled), #copy-all-btn:hover:not(:disabled), #refresh-btn:hover:not(:disabled), #export-btn:hover:not(:disabled), #port-scan-btn:hover:not(:disabled), #traceroute-btn:hover:not(:disabled), #whois-btn:hover:not(:disabled), #speed-test-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.5);
        }
        #copy-btn:disabled, #copy-all-btn:disabled, #refresh-btn:disabled, #export-btn:disabled, #port-scan-btn:disabled, #traceroute-btn:disabled, #whois-btn:disabled, #speed-test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none;
        }
        #copy-feedback {
            color: #2ecc71;
            font-size: 14px;
            margin-top: 10px;
            display: none;
            transition: opacity 0.3s ease;
        }
        #map {
            height: 320px;
            width: 100%;
            border-radius: 16px;
            margin-top: 25px;
            box-shadow: 0 5px 20px var(--shadow);
            animation: mapFadeIn 1s ease-in-out;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            padding: 20px;
            box-shadow: 5px 0 15px var(--shadow);
            transition: left 0.3s ease;
            overflow-y: auto;
        }
        .sidebar.open {
            left: 0;
        }
        .dark .sidebar {
            background: var(--dark-card);
        }
        .sidebar h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #3498db;
        }
        .history-item {
            background: #edf2f7;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 14px;
        }
        .dark .history-item {
            background: #2d3748;
        }
        .toggle-sidebar {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            transition: transform 0.2s ease;
        }
        .toggle-sidebar:hover {
            transform: scale(1.1);
        }
        footer {
            margin-top: 30px;
        }
        .small-text {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }
        .dark .small-text {
            color: #b0b8cc;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid #ddd;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }
        .dark .spinner {
            border-color: #555;
            border-top-color: #3498db;
        }
        .mode-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            transition: transform 0.2s ease;
        }
        .mode-toggle:hover {
            transform: rotate(15deg);
        }
        .dark .mode-toggle {
            color: #dark-text;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); opacity: 1; }
            50% { opacity: 0.7; }
            100% { transform: rotate(360deg); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes mapFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes rippleEffect {
            to { transform: scale(4); opacity: 0; }
        }
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            h1 {
                font-size: 32px;
            }
            .ip-container {
                font-size: 26px;
                gap: 20px;
                padding: 15px;
            }
            .buttons {
                flex-direction: column;
                gap: 10px;
            }
            #copy-btn, #copy-all-btn, #refresh-btn, #export-btn, #port-scan-btn, #traceroute-btn, #whois-btn, #speed-test-btn {
                padding: 12px 20px;
                font-size: 15px;
            }
            #map {
                height: 220px;
            }
            .small-text {
                font-size: 12px;
            }
            .sidebar {
                width: 250px;
                left: -250px;
            }
            .info-text {
                width: 150px;
                left: 0;
                top: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="history-sidebar">
        <h2>IP History</h2>
        <div id="history-list"></div>
    </div>
    <div class="container">
        <button class="toggle-sidebar" aria-label="Toggle history sidebar">üìú</button>
        <button class="mode-toggle" aria-label="Toggle dark mode">üåô</button>
        <h1>What's My IP?</h1>
        <div class="ip-container">
            <div class="ip-info">
                <div class="info-item">
                    <span id="ip" data-tooltip="Your public IPv4 address"><span class="spinner"></span></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Your IPv4 address is a unique identifier for your device on the internet.</div>
                </div>
                <div class="info-item">
                    <span id="ipv6" class="small-text" data-tooltip="Your IPv6 address"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">IPv6 is the next-generation IP protocol with a larger address space.</div>
                </div>
                <div class="info-item">
                    <span id="isp" class="small-text" data-tooltip="Internet Service Provider"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">The company providing your internet connection.</div>
                </div>
                <div class="info-item">
                    <span id="asn" class="small-text" data-tooltip="Autonomous System Number"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">A unique number assigned to an autonomous network system.</div>
                </div>
                <div class="info-item">
                    <span id="hostname" class="small-text" data-tooltip="Device hostname"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">The name assigned to your device on the network.</div>
                </div>
                <div class="info-item">
                    <span id="coords" class="small-text" data-tooltip="Latitude & Longitude"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Geographic coordinates approximating your location.</div>
                </div>
                <div class="info-item">
                    <span id="network-status" class="small-text" data-tooltip="Network connectivity"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Indicates if your device is online or offline.</div>
                </div>
                <div class="info-item">
                    <span id="latency" class="small-text" data-tooltip="Network latency (ping)"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Time taken for data to travel to a server and back (in ms).</div>
                </div>
                <div class="info-item">
                    <span id="vpn-status" class="small-text" data-tooltip="VPN usage detection"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Checks if your connection is routed through a VPN.</div>
                </div>
                <div class="info-item">
                    <span id="dns-servers" class="small-text" data-tooltip="DNS servers (WebRTC)"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Servers translating domain names to IP addresses.</div>
                </div>
                <div class="info-item">
                    <span id="open-ports" class="small-text" data-tooltip="Common open ports"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Ports open on your IP, indicating accessible services.</div>
                </div>
                <div class="info-item">
                    <span id="threat-status" class="small-text" data-tooltip="IP blacklist check"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Checks if your IP is flagged as malicious.</div>
                </div>
                <div class="info-item">
                    <span id="traceroute" class="small-text" data-tooltip="Network path"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Route your data takes to reach a server.</div>
                </div>
                <div class="info-item">
                    <span id="whois" class="small-text" data-tooltip="WHOIS lookup"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Registration details for your IP or hostname.</div>
                </div>
                <div class="info-item">
                    <span id="speed-test" class="small-text" data-tooltip="Network speed"></span>
                    <button class="info-btn">‚ÑπÔ∏è</button>
                    <div class="info-text">Download and upload speeds of your connection.</div>
                </div>
            </div>
            <div class="buttons">
                <button id="copy-btn" disabled>Copy IPv4</button>
                <button id="copy-all-btn" disabled>Copy All</button>
                <button id="refresh-btn">Refresh</button>
                <button id="export-btn" disabled>Export</button>
                <button id="port-scan-btn" disabled>Scan Ports</button>
                <button id="traceroute-btn" disabled>Traceroute</button>
                <button id="whois-btn" disabled>WHOIS</button>
                <button id="speed-test-btn" disabled>Speed Test</button>
            </div>
        </div>
        <span id="copy-feedback" class="small-text"></span>
        <div id="map"></div>
        <footer>
            <p class="small-text">Your all-in-one toolkit for IP and network analysis.</p>
            <p class="small-text">No data stored. Powered by ipapi.co, MapLibre, and OpenStreetMap. <a href="https://techfixpro.net/privacy-policy.html">Privacy Policy</a></p>
        </footer>
    </div>

    <script>
        let ipHistory = [];
        let currentIP = null;

        async function fetchIP() {
            try {
                const response = await fetch("https://ipapi.co/json/");
                const data = await response.json();
                currentIP = data.ip;
                const ipElement = document.getElementById("ip");
                const ipv6Element = document.getElementById("ipv6");
                const ispElement = document.getElementById("isp");
                const asnElement = document.getElementById("asn");
                const hostnameElement = document.getElementById("hostname");
                const coordsElement = document.getElementById("coords");
                const networkStatusElement = document.getElementById("network-status");
                const latencyElement = document.getElementById("latency");
                const vpnStatusElement = document.getElementById("vpn-status");
                const dnsServersElement = document.getElementById("dns-servers");
                const openPortsElement = document.getElementById("open-ports");
                const threatStatusElement = document.getElementById("threat-status");
                const tracerouteElement = document.getElementById("traceroute");
                const whoisElement = document.getElementById("whois");
                const speedTestElement = document.getElementById("speed-test");
                const copyBtn = document.getElementById("copy-btn");
                const copyAllBtn = document.getElementById("copy-all-btn");
                const exportBtn = document.getElementById("export-btn");
                const portScanBtn = document.getElementById("port-scan-btn");
                const tracerouteBtn = document.getElementById("traceroute-btn");
                const whoisBtn = document.getElementById("whois-btn");
                const speedTestBtn = document.getElementById("speed-test-btn");

                ipElement.innerHTML = data.ip || "Not available";
                ipv6Element.innerHTML = data.ipv6 || "IPv6 not detected";
                ispElement.innerHTML = data.org || "Unknown ISP";
                asnElement.innerHTML = data.asn || "Unknown ASN";
                hostnameElement.innerHTML = data.hostname || "Hostname not available";
                coordsElement.innerHTML = `${data.latitude}, ${data.longitude}`;

                updateNetworkStatus(networkStatusElement);

                const startTime = performance.now();
                await fetch("https://ipapi.co/json/", { method: "HEAD" });
                const latency = Math.round(performance.now() - startTime);
                latencyElement.innerHTML = `${latency} ms<span class="status-badge ${latency < 100 ? 'online' : 'offline'}">${latency < 100 ? 'Fast' : 'Slow'}</span>`;

                const browserTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const ipTz = data.timezone;
                const isVpnLikely = browserTz !== ipTz || data.vpn || data.proxy;
                vpnStatusElement.innerHTML = `${isVpnLikely ? 'VPN Detected' : 'No VPN'}<span class="status-badge ${isVpnLikely ? 'vpn-detected' : 'online'}">${isVpnLikely ? 'Likely' : 'Unlikely'}</span>`;

                const dnsServers = await getDNSServers();
                dnsServersElement.innerHTML = dnsServers.length ? dnsServers.join(", ") : "Not detected";

                const ports = await checkCommonPorts(data.ip);
                openPortsElement.innerHTML = ports.length ? ports.join(", ") : "None detected";

                const threatLevel = await checkIPThreat(data.ip);
                threatStatusElement.innerHTML = `${threatLevel}<span class="status-badge ${threatLevel.includes('Threat') ? 'threat-detected' : 'online'}">${threatLevel.includes('Threat') ? 'Risk' : 'Safe'}</span>`;

                tracerouteElement.innerHTML = "Awaiting traceroute...";
                whoisElement.innerHTML = "Awaiting WHOIS...";
                speedTestElement.innerHTML = "Awaiting speed test...";

                copyBtn.disabled = false;
                copyBtn.onclick = (e) => {
                    addRippleEffect(e);
                    navigator.clipboard.writeText(data.ip);
                    showFeedback("IPv4 Copied!");
                };

                const allData = `IPv4: ${data.ip || 'N/A'}\nIPv6: ${data.ipv6 || 'N/A'}\nISP: ${data.org || 'N/A'}\nASN: ${data.asn || 'N/A'}\nHostname: ${data.hostname || 'N/A'}\nCoords: ${data.latitude}, ${data.longitude}\nNetwork: ${navigator.onLine ? 'Online' : 'Offline'}\nLatency: ${latency} ms\nVPN: ${isVpnLikely ? 'Yes' : 'No'}\nDNS: ${dnsServers.length ? dnsServers.join(", ") : 'N/A'}\nPorts: ${ports.length ? ports.join(", ") : 'N/A'}\nThreat: ${threatLevel}`;
                copyAllBtn.disabled = false;
                copyAllBtn.onclick = (e) => {
                    addRippleEffect(e);
                    navigator.clipboard.writeText(allData);
                    showFeedback("All Data Copied!");
                };

                exportBtn.disabled = false;
                exportBtn.onclick = (e) => {
                    addRippleEffect(e);
                    exportToJSON(data, { latency, vpn: isVpnLikely, dns: dnsServers, ports, threat: threatLevel });
                };

                portScanBtn.disabled = false;
                portScanBtn.onclick = (e) => {
                    addRippleEffect(e);
                    runPortScan(data.ip, openPortsElement);
                };

                tracerouteBtn.disabled = false;
                tracerouteBtn.onclick = (e) => {
                    addRippleEffect(e);
                    runTraceroute(data.ip, tracerouteElement);
                };

                whoisBtn.disabled = false;
                whoisBtn.onclick = (e) => {
                    addRippleEffect(e);
                    runWhois(data.hostname || data.ip, whoisElement);
                };

                speedTestBtn.disabled = false;
                speedTestBtn.onclick = (e) => {
                    addRippleEffect(e);
                    runSpeedTest(speedTestElement);
                };

                const map = new maplibregl.Map({
                    container: 'map',
                    style: {
                        'version': 8,
                        'sources': {
                            'osm-tiles': {
                                'type': 'raster',
                                'tiles': ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                                'tileSize': 256,
                                'attribution': 'Map data ¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }
                        },
                        'layers': [{
                            'id': 'osm-tiles',
                            'type': 'raster',
                            'source': 'osm-tiles',
                            'minzoom': 0,
                            'maxzoom': 19
                        }]
                    },
                    center: [data.longitude, data.latitude],
                    zoom: 10
                });
                map.addControl(new maplibregl.NavigationControl());
                const marker = new maplibregl.Marker({ color: '#3498db' })
                    .setLngLat([data.longitude, data.latitude])
                    .setPopup(new maplibregl.Popup().setText(`Near ${data.city}, ${data.region}`))
                    .addTo(map)
                    .togglePopup();
                map.on('load', () => {
                    map.addSource('coords-overlay', {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [data.longitude, data.latitude]
                            }
                        }
                    });
                    map.addLayer({
                        'id': 'coords-circle',
                        'type': 'circle',
                        'source': 'coords-overlay',
                        'paint': {
                            'circle-radius': 12,
                            'circle-color': '#3498db',
                            'circle-opacity': 0.4
                        }
                    });
                });

                addToHistory(data, { latency, vpn: isVpnLikely, dns: dnsServers, ports, threat: threatLevel });
            } catch (error) {
                const ipElement = document.getElementById("ip");
                ipElement.innerHTML = `Error: ${error.message || "Check your connection"}`;
                disableButtons();
            }
        }

        function showFeedback(message) {
            const feedback = document.getElementById("copy-feedback");
            feedback.textContent = message;
            feedback.style.display = "inline";
            feedback.style.opacity = "1";
            setTimeout(() => feedback.style.opacity = "0", 1500);
            setTimeout(() => feedback.style.display = "none", 1800);
        }

        function updateNetworkStatus(element) {
            const isOnline = navigator.onLine;
            element.innerHTML = `${isOnline ? 'Online' : 'Offline'}<span class="status-badge ${isOnline ? 'online' : 'offline'}">${isOnline ? 'Connected' : 'Disconnected'}</span>`;
        }

        async function getDNSServers() {
            return new Promise(resolve => {
                const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
                pc.createDataChannel("");
                pc.createOffer()
                    .then(offer => pc.setLocalDescription(offer))
                    .catch(() => resolve([]));
                pc.onicecandidate = (ice) => {
                    if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                    const servers = ice.candidate.candidate.match(/(?:\d{1,3}\.){3}\d{1,3}/g) || [];
                    pc.close();
                    resolve(servers);
                };
                setTimeout(() => { pc.close(); resolve([]); }, 1000);
            });
        }

        async function checkCommonPorts(ip) {
            const commonPorts = [80, 443];
            const results = [];
            for (const port of commonPorts) {
                try {
                    const response = await fetch(`http://localhost:3000/port-scan?ip=${ip}&port=${port}`, { method: 'GET' });
                    if (response.ok) results.push(port);
                } catch (_) {}
            }
            return results.length ? results : ["Server-side scan required"];
        }

        async function runPortScan(ip, element) {
            element.innerHTML = "Scanning...";
            const ports = await checkCommonPorts(ip);
            element.innerHTML = ports.length ? ports.join(", ") : "None detected (server-side recommended)";
        }

        async function runTraceroute(ip, element) {
            element.innerHTML = "Tracing...";
            try {
                const response = await fetch(`http://localhost:3000/traceroute?ip=${ip}`);
                const data = await response.json();
                element.innerHTML = data.hops ? data.hops.join(" -> ") : "Server-side traceroute required";
            } catch {
                element.innerHTML = "Server-side traceroute required";
            }
        }

        async function runWhois(target, element) {
            element.innerHTML = "Fetching WHOIS...";
            try {
                const response = await fetch(`https://api.who.is/whois/${target}`);
                const data = await response.json();
                element.innerHTML = data.registrar ? `${data.registrar} (${data.expires})` : "No WHOIS data";
            } catch {
                element.innerHTML = "WHOIS unavailable";
            }
        }

        async function runSpeedTest(element) {
            element.innerHTML = "Testing...";
            try {
                const response = await fetch("http://localhost:3000/speed-test");
                const data = await response.json();
                element.innerHTML = `Down: ${data.download} Mbps, Up: ${data.upload} Mbps`;
            } catch {
                const start = performance.now();
                await fetch("https://ipapi.co/json/", { method: "HEAD" });
                const latency = Math.round(performance.now() - start);
                element.innerHTML = `Latency: ${latency} ms (Full test requires server)`;
            }
        }

        async function checkIPThreat(ip) {
            return "No threats detected"; // Placeholder
        }

        function addRippleEffect(event) {
            const btn = event.target;
            const ripple = document.createElement("span");
            ripple.classList.add("ripple");
            const rect = btn.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = `${size}px`;
            ripple.style.left = `${event.clientX - rect.left - size / 2}px`;
            ripple.style.top = `${event.clientY - rect.top - size / 2}px`;
            btn.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        function addToHistory(data, extra) {
            const timestamp = new Date().toLocaleString();
            ipHistory.unshift({ ...data, ...extra, timestamp });
            if (ipHistory.length > 10) ipHistory.pop();
            updateHistoryUI();
        }

        function updateHistoryUI() {
            const historyList = document.getElementById("history-list");
            historyList.innerHTML = ipHistory.map(item => `
                <div class="history-item">
                    <strong>${item.ip || 'N/A'}</strong> (${item.timestamp})<br>
                    IPv6: ${item.ipv6 || 'N/A'}<br>
                    ISP: ${item.org || 'N/A'}<br>
                    Latency: ${item.latency} ms<br>
                    VPN: ${item.vpn ? 'Yes' : 'No'}
                </div>
            `).join("");
        }

        function exportToJSON(data, extra) {
            const json = JSON.stringify({ ...data, ...extra, timestamp: new Date().toISOString() }, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `ip-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function disableButtons() {
            document.getElementById("copy-btn").disabled = true;
            document.getElementById("copy-all-btn").disabled = true;
            document.getElementById("export-btn").disabled = true;
            document.getElementById("port-scan-btn").disabled = true;
            document.getElementById("traceroute-btn").disabled = true;
            document.getElementById("whois-btn").disabled = true;
            document.getElementById("speed-test-btn").disabled = true;
        }

        fetchIP();

        window.addEventListener('online', () => updateNetworkStatus(document.getElementById("network-status")));
        window.addEventListener('offline', () => updateNetworkStatus(document.getElementById("network-status")));

        document.getElementById("refresh-btn").addEventListener("click", (e) => {
            addRippleEffect(e);
            document.getElementById("ip").innerHTML = '<span class="spinner"></span>';
            document.getElementById("ipv6").innerHTML = "";
            document.getElementById("isp").innerHTML = "";
            document.getElementById("asn").innerHTML = "";
            document.getElementById("hostname").innerHTML = "";
            document.getElementById("coords").innerHTML = "";
            document.getElementById("network-status").innerHTML = "";
            document.getElementById("latency").innerHTML = "";
            document.getElementById("vpn-status").innerHTML = "";
            document.getElementById("dns-servers").innerHTML = "";
            document.getElementById("open-ports").innerHTML = "";
            document.getElementById("threat-status").innerHTML = "";
            document.getElementById("traceroute").innerHTML = "";
            document.getElementById("whois").innerHTML = "";
            document.getElementById("speed-test").innerHTML = "";
            fetchIP();
        });

        document.querySelector(".toggle-sidebar").addEventListener("click", () => {
            document.getElementById("history-sidebar").classList.toggle("open");
        });

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            document.querySelector(".mode-toggle").textContent = "‚òÄÔ∏è";
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            document.body.classList.toggle("dark", e.matches);
            document.querySelector(".mode-toggle").textContent = e.matches ? "‚òÄÔ∏è" : "üåô";
        });
        document.querySelector(".mode-toggle").addEventListener("click", () => {
            document.body.classList.toggle("dark");
            document.querySelector(".mode-toggle").textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
        });
    </script>
</body>
</html>
